box: node:7.10

test:
  steps:
    - script:
        name: echo nodejs information
        code: |
          echo "node version $(node -v) running"
          echo "npm version $(npm -v) running"

    - script:
        name: npm-install
        code: |
          npm install

    - script:
        name: npm-test
        code: |
          npm test

    - script:
        name: npm-build
        code: |
          npm run build

build:
  steps:
#    - script:
#        name: install-yarn
#        code: |
#          curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add -
#          echo "deb https://dl.yarnpkg.com/debian/ stable main" | tee /etc/apt/sources.list.d/yarn.list
#          apt-get update && apt-get install yarn
#          yarn --version
    - script:
        name: npm-build
        code: |
          rm -rf ./build
          npm run build

    - script:
        name: check-build-dir
        code: |
          ls -la ./build

deploy:
  steps:
    - script:
        name: install-cf-cli
        code: |
          wget -O cf.tgz https://cli.run.pivotal.io/stable?release=linux64-binary
          tar -zxf cf.tgz
          export PATH=.:$PATH
          cf version

    - script:
        name: install-autopilot-plugin
        code: |
          wget -O autopilot https://github.com/contraband/autopilot/releases/download/0.0.3/autopilot-linux
          chmod +x autopilot
          cf install-plugin autopilot -f

    - script:
        name: cf-login
        code: |
          cf login -a https://api.run.pivotal.io -u $CF_USER -p "$CF_PASS" -o cohesioned -s $CF_SPACE

    - script:
        name: cf-push
        code: |
          cf zero-downtime-push web -f ${CF_SPACE}-manifest.yml
